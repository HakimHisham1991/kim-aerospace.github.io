<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>rev13 Interdepartmental Forms - Locking Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
    .user-bar { background-color: #e3f2fd; padding: 12px 20px; border-radius: 8px; display: inline-block; font-size: 16px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .user-bar span { font-weight: bold; color: #1976d2; }
    .login-btn { background-color: #4CAF50; padding: 10px 20px; font-size: 16px; margin-right: 10px; }
    .logout-btn { background-color: #f44336; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #4CAF50; color: white; }
    button { padding: 8px 12px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background-color: #aaa; }
    .editing { color: #d32f2f; font-weight: bold; }
    .free { color: #388e3c; }
    .admin-btn { background-color: #f44336; margin-top: 20px; padding: 10px 20px; font-size: 16px; }
</style>
</head>
<body>

<div class="user-bar">
    Current User: <span id="currentUser">Not logged in</span>
    <button class="login-btn" id="loginBtn" onclick="login()">Login as...</button>
    <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
</div>

<h1>Interdepartmental Stamping Forms</h1>

<table id="formsTable">
    <tbody>
        <tr data-form="PCN/25/AG01/001">
            <td>PCN/25/AG01/001</td>
            <td class="status">None</td>
            <td><button onclick="openForm('PCN/25/AG01/001')">Open Form</button></td>
        </tr>
        <tr data-form="PCN/25/AG01/002">
            <td>PCN/25/AG01/002</td>
            <td class="status">None</td>
            <td><button onclick="openForm('PCN/25/AG01/002')">Open Form</button></td>
        </tr>
        <tr data-form="PCN/25/AL10/001">
            <td>PCN/25/AL10/001</td>
            <td class="status">None</td>
            <td><button onclick="openForm('PCN/25/AL10/001')">Open Form</button></td>
        </tr>
    </tbody>
</table>

<button class="admin-btn" onclick="clearAllLocks()">Clear All Locks (for testing)</button>

<script>
let CURRENT_USER = localStorage.getItem('currentDemoUser') || '';

function updateUserDisplay() {
    const userSpan = document.getElementById('currentUser');
    if (CURRENT_USER) {
        userSpan.textContent = CURRENT_USER;
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';
    } else {
        userSpan.textContent = 'Not logged in';
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('logoutBtn').style.display = 'none';
    }
    refreshLocks();
}

function login() {
    const username = prompt("Enter your username:", "UserA");
    if (username && username.trim()) {
        CURRENT_USER = username.trim();
        localStorage.setItem('currentDemoUser', CURRENT_USER);
        updateUserDisplay();
    }
}

function logout() {
    if (confirm('Logout?')) {
        localStorage.removeItem('currentDemoUser');
        CURRENT_USER = '';
        updateUserDisplay();
    }
}

const LOCK_TIMEOUT = 5 * 60 * 1000;

function refreshLocks() {
    const rows = document.querySelectorAll('#formsTable tbody tr');
    rows.forEach(row => {
        const formId = row.getAttribute('data-form');
        const statusCell = row.querySelector('.status');
        const button = row.querySelector('button');
        const lockKey = 'lock_' + formId;
        const lockData = localStorage.getItem(lockKey);

        if (lockData) {
            const parsed = JSON.parse(lockData);
            const age = Date.now() - parsed.timestamp;
            if (age > LOCK_TIMEOUT) {
                localStorage.removeItem(lockKey);
                statusCell.textContent = "None";
                statusCell.className = "status free";
                button.textContent = "Open Form";
                button.disabled = false;
            } else {
                statusCell.textContent = parsed.user + " (editing)";
                statusCell.className = "status editing";
                if (parsed.user === CURRENT_USER) {
                    button.textContent = "You are editing";
                    button.disabled = true;
                } else {
                    button.textContent = "Open (Read-Only)";
                    button.disabled = false;
                }
            }
        } else {
            statusCell.textContent = "None";
            statusCell.className = "status free";
            button.textContent = "Open Form";
            button.disabled = false;
        }
    });
}

function openForm(formId) {
    if (!CURRENT_USER) {
        alert("Please login first!");
        return;
    }

    const lockKey = 'lock_' + formId;
    const lockData = localStorage.getItem(lockKey);
    let canEdit = true;

    if (lockData) {
        const parsed = JSON.parse(lockData);
        const age = Date.now() - parsed.timestamp;
        if (age > LOCK_TIMEOUT) {
            localStorage.removeItem(lockKey);
        } else if (parsed.user !== CURRENT_USER) {
            canEdit = false;
        }
    }

    // Always set/refresh lock if canEdit (first user or your own)
    if (canEdit) {
        localStorage.setItem(lockKey, JSON.stringify({
            user: CURRENT_USER,
            timestamp: Date.now()
        }));
    }

    // Pass username and edit mode via URL
    const params = `?form=\( {encodeURIComponent(formId)}&user= \){encodeURIComponent(CURRENT_USER)}&edit=${canEdit ? 1 : 0}`;
    window.open('form.html' + params, '_blank');

    setTimeout(refreshLocks, 500);
}

function clearAllLocks() {
    if (confirm("Clear ALL locks?")) {
        Object.keys(localStorage)
            .filter(k => k.startsWith('lock_'))
            .forEach(k => localStorage.removeItem(k));
        refreshLocks();
        alert("All locks cleared!");
    }
}

updateUserDisplay();
setInterval(refreshLocks, 5000);
refreshLocks();
</script>

<p><small>Tip: As the first user, you will always get edit mode after clearing locks.</small></p>
</body>
</html>