<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interdepartmental Forms - Locking Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #f5f5f5;
    }
    h1 {
        color: #333;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #4CAF50;
        color: white;
    }
    tr:hover {
        background-color: #f1f1f1;
    }
    button {
        padding: 8px 12px;
        background-color: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    button:hover {
        background-color: #1976D2;
    }
    button:disabled {
        background-color: #aaa;
        cursor: not-allowed;
    }
    .editing {
        color: #d32f2f;
        font-weight: bold;
    }
    .free {
        color: #388e3c;
    }
</style>
</head>
<body>

<h1>Interdepartmental Stamping Forms</h1>

<table id="formsTable">
    <thead>
        <tr>
            <th>Form ID</th>
            <th>Now Editing</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <tr data-form="PCN/25/AG01/001">
            <td>PCN/25/AG01/001</td>
            <td class="status">None</td>
            <td><button onclick="openForm('PCN/25/AG01/001')">Open Form</button></td>
        </tr>
        <tr data-form="PCN/25/AG01/002">
            <td>PCN/25/AG01/002</td>
            <td class="status">None</td>
            <td><button onclick="openForm('PCN/25/AG01/002')">Open Form</button></td>
        </tr>
        <tr data-form="PCN/25/AL10/001">
            <td>PCN/25/AL10/001</td>
            <td class="status">None</td>
            <td><button onclick="openForm('PCN/25/AL10/001')">Open Form</button></td>
        </tr>
    </tbody>
</table>

<script>
// Simulate different users by changing this name (for demo on same browser)
const CURRENT_USER = prompt("Enter your username for this session:", "UserA") || "UserA";

// Lock expiration time: 5 minutes (300000 ms)
const LOCK_TIMEOUT = 5 * 60 * 1000;

// Load and display current lock status for all forms
function refreshLocks() {
    const rows = document.querySelectorAll('#formsTable tbody tr');
    rows.forEach(row => {
        const formId = row.getAttribute('data-form');
        const statusCell = row.querySelector('.status');
        const button = row.querySelector('button');

        const lockData = localStorage.getItem('lock_' + formId);
        if (lockData) {
            const { user, timestamp } = JSON.parse(lockData);
            const age = Date.now() - timestamp;

            if (age > LOCK_TIMEOUT) {
                // Expired lock
                localStorage.removeItem('lock_' + formId);
                statusCell.textContent = "None";
                statusCell.className = "status free";
                button.disabled = false;
                button.textContent = "Open Form";
            } else {
                // Active lock
                statusCell.textContent = user + " (editing)";
                statusCell.className = "status editing";
                if (user === CURRENT_USER) {
                    button.textContent = "You are editing (in another tab)";
                    button.disabled = true;
                } else {
                    button.textContent = "Locked - Read Only";
                    button.disabled = false; // Still allow opening as read-only
                }
            }
        } else {
            statusCell.textContent = "None";
            statusCell.className = "status free";
            button.disabled = false;
            button.textContent = "Open Form";
        }
    });
}

// Open form in new tab and attempt to lock
function openForm(formId) {
    const lockKey = 'lock_' + formId;
    const existing = localStorage.getItem(lockKey);

    let canEdit = true;
    if (existing) {
        const { user, timestamp } = JSON.parse(existing);
        if (Date.now() - timestamp <= LOCK_TIMEOUT && user !== CURRENT_USER) {
            canEdit = false; // Locked by someone else
        }
    }

    // Always set/update the lock for this user
    localStorage.setItem(lockKey, JSON.stringify({
        user: CURRENT_USER,
        timestamp: Date.now()
    }));

    // Open the "form" page (simulated)
    const editParam = canEdit ? "?edit=1" : "?edit=0";
    const newTab = window.open('form.html?form=' + encodeURIComponent(formId) + editParam, '_blank');

    // Refresh the list immediately
    refreshLocks();

    // If user closes the tab without proper unlock, lock will expire automatically
}

// Refresh every 5 seconds to detect changes from other tabs/users
setInterval(refreshLocks, 5000);
refreshLocks(); // Initial load
</script>

<p><small><strong>Demo Note:</strong> Open this page in multiple tabs or browser windows with different usernames to simulate multiple users. Locks expire after 5 minutes of inactivity.</small></p>

</body>
</html>