<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>rev11 Form Viewer</title>
<style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    .user-info { background-color: #e3f2fd; padding: 10px 15px; border-radius: 6px; display: inline-block; font-weight: bold; margin-bottom: 20px; color: #1976d2; }
    .readonly { opacity: 0.7; pointer-events: none; }
    button { padding: 10px 20px; margin: 10px 10px 10px 0; cursor: pointer; }
    .force-unlock { background-color: #f44336; color: white; }
</style>
</head>
<body>

<div class="user-info">
    Current User: <span id="currentUser">Loading...</span>
</div>

<h1 id="formId">Form Loading...</h1>
<p id="mode">Loading...</p>

<div id="formContent">
    <label>Department Approval: <input type="text" id="approval"></label><br><br>
    <label>Comments: <textarea id="comments" rows="5" cols="50"></textarea></label><br><br>
    <button onclick="saveForm()">Save Changes</button>
    <button onclick="closeForm()">Close / Unlock</button>
    <button class="force-unlock" onclick="forceUnlock()">Force Unlock (testing)</button>
</div>

<script>
const params = new URLSearchParams(location.search);
const formId = params.get('form') || 'Unknown';
const urlUser = params.get('user') || 'Unknown';
const canEdit = params.get('edit') === '1';

// Fixed display
document.getElementById('currentUser').textContent = urlUser;
document.getElementById('formId').textContent = 'Form: ' + formId;

if (canEdit) {
    document.getElementById('mode').textContent = 'You are editing this form (full access).';
} else {
    document.getElementById('formContent').classList.add('readonly');
    document.getElementById('mode').textContent = 'READ-ONLY: Locked by another user.';
}

function saveForm() {
    if (!canEdit) {
        alert('Cannot save in read-only mode.');
        return;
    }
    alert('Changes saved successfully for ' + formId + '!\n(Demo only - in real app, this would submit to server)');
}

function closeForm() {
    if (canEdit) {
        localStorage.removeItem('lock_' + formId);
        alert('Form unlocked.');
    }
    window.close();
}

function forceUnlock() {
    if (confirm('Force unlock?')) {
        localStorage.removeItem('lock_' + formId);
        alert('Unlocked!');
        location.reload();
    }
}

// Keep lock alive if you have edit mode
if (canEdit) {
    setInterval(() => {
        localStorage.setItem('lock_' + formId, JSON.stringify({
            user: urlUser,
            timestamp: Date.now()
        }));
    }, 20000);
}
</script>
</body>
</html>