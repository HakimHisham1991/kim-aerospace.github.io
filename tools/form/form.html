<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Form Viewer</title>
<style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    .user-info { background-color: #e3f2fd; padding: 10px 15px; border-radius: 6px; display: inline-block; font-weight: bold; margin-bottom: 20px; color: #1976d2; }
    .readonly { opacity: 0.7; }
    button { padding: 10px 20px; margin: 10px 10px 10px 0; cursor: pointer; }
    .force-unlock { background-color: #f44336; color: white; }
</style>
</head>
<body>

<div class="user-info">
    Current User: <span id="currentUser">Loading...</span>
</div>

<h1 id="formId">Form Loading...</h1>
<p id="mode">Loading...</p>

<div id="formContent">
    <label>Department Approval: <input type="text" id="approval"></label><br><br>
    <label>Comments: <textarea id="comments" rows="5" cols="50"></textarea></label><br><br>
    <button onclick="saveForm()">Save Changes</button>
    <button onclick="closeForm()">Close / Unlock</button>
    <button class="force-unlock" onclick="forceUnlock()">Force Unlock (testing)</button>
</div>

<script>
const params = new URLSearchParams(location.search);
const formId = params.get('form') || 'Unknown';
const urlEdit = params.get('edit') === '1';

let currentUser = localStorage.getItem('currentDemoUser') || 'Unknown';
document.getElementById('currentUser').textContent = currentUser;
document.getElementById('formId').textContent = 'Form: ' + formId;

if (urlEdit) {
    document.getElementById('mode').textContent = 'You are editing this form.';
} else {
    document.getElementById('formContent').classList.add('readonly');
    document.querySelectorAll('input, textarea, button:first-of-type').forEach(el => el.disabled = true);
    document.getElementById('mode').textContent = 'READ-ONLY: This form is being edited by another user.';
}

function saveForm() {
    alert('Changes saved for ' + formId + ' (demo only)\nUser: ' + currentUser);
}

function closeForm() {
    unlockAndClose();
}

function forceUnlock() {
    if (confirm('Force unlock this form?')) {
        localStorage.removeItem('lock_' + formId);
        alert('Forced unlock!');
        location.reload();
    }
}

function unlockAndClose() {
    const lockKey = 'lock_' + formId;
    const lockData = localStorage.getItem(lockKey);
    if (lockData) {
        const parsed = JSON.parse(lockData);
        if (parsed.user.toLowerCase() === currentUser.toLowerCase()) {
            localStorage.removeItem(lockKey);
        }
    }
    window.close();
}

// Heartbeat to keep lock alive
setInterval(() => {
    const lockKey = 'lock_' + formId;
    const lockData = localStorage.getItem(lockKey);
    if (lockData) {
        const parsed = JSON.parse(lockData);
        if (parsed.user.toLowerCase() === currentUser.toLowerCase()) {
            parsed.timestamp = Date.now();
            localStorage.setItem(lockKey, JSON.stringify(parsed));
        }
    }
}, 20000); // Every 20 seconds
</script>
</body>
</html>